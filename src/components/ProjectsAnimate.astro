---
import Section from "./Section.astro";
import type { ProjectProps } from "@types";

interface Props {
  projects: ProjectProps[];
}

const { projects } = Astro.props;

// Serialize projects for the client
const serializedProjects = projects.map(p => ({
  name: p.name,
  summary: p.summary,
  image: p.image,
  linkPreview: p.linkPreview,
  linkSource: p.linkSource
}));
---

<Section text="Featured Projects" href="projects">
  <section id="projects" class="work"></section>
</Section>

<!-- Pass data to client script -->
<script type="application/json" id="projects-data" set:html={JSON.stringify(serializedProjects)} is:inline />

<script>
import { gsap } from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";
import Lenis from 'lenis';

document.addEventListener('DOMContentLoaded', () => {
    gsap.registerPlugin(ScrollTrigger);

    const lenis = new Lenis();
    lenis.on("scroll", ScrollTrigger.update);
    gsap.ticker.add((time) => {
        lenis.raf(time * 1000);
    })
    gsap.ticker.lagSmoothing(0);

    // Get projects from the JSON script tag
    const projectsData = document.getElementById('projects-data');
    
    if (!projectsData || !projectsData.textContent) {
        console.error('Could not find projects-data element');
        return;
    }

    const projects = JSON.parse(projectsData.textContent);

    const workContainer = document.querySelector('.work');

    if (!workContainer) {
        console.error('Could not find work container');
        return;
    }

    const createWorkItem = (project: { name: string; summary: string; image: string }) => {
        const workItem = document.createElement('div');
        workItem.className = "work-item";
        workItem.innerHTML = `
            <div class="work-item-img my-16">
                <img src="${project.image}" alt="${project.name}" />
            </div>
            <div class="work-item-copy">
                <h3 class="text-3xl font-medium font-serif mb-5 text-primary">${project.name}</h3>
                <p class="text-neutral text-base">${project.summary}</p>
            </div>
        `;
        return workItem;       
    }

    // Create rows with 2 items each
for (let i = 0; i < projects.length; i += 1) {
    const row = document.createElement('div');
    row.className = "row";

    row.appendChild(createWorkItem(projects[i]));

    workContainer.appendChild(row);
}

    // Initial GSAP setup
    gsap.set(".work-item", {
        y: 1000,
    })

    document.querySelectorAll(".row").forEach((row, rowIndex) => {
        const workItems = row.querySelectorAll(".work-item");

        // Set initial alternating rotation for each work item (here one item per row)
        workItems.forEach((item) => {
            const rotation = (rowIndex % 2 === 0) ? 60 : -60;
            gsap.set(item, {
                rotation: rotation,
                transformOrigin: "center center",
            });
        });

        // Create scroll trigger to animate rotation and position to normal on row entering viewport
        ScrollTrigger.create({
            trigger: row,
            start: "top 52%",
            onEnter: () => {
                gsap.to(workItems, {
                    y: 0,
                    rotation: 0,
                    duration: 1,
                    ease: "power4.out",
                    stagger: 0.25,
                });
            }
        });
    });

});
</script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    header {
        position: relative;
        width: 100%;
        height: 400px;
        text-align: left;
        align-content: center;
        padding: 1.25rem;
    }
    
    .work {
        position: relative;
        width: 100%;
        min-height: 500px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 3rem;
        overflow: hidden;
    }

    .row {
        width: 100%;
        display: flex;
        gap: 1.5rem;
    }

    .work-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .work-item-img {
        aspect-ratio: 4/3;
        overflow: hidden;
        background-color: #ddd;
    }

    .work-item-copy h3 {
        color: white;
        font-size: 1.5rem;
    }

    .work-item-copy p {
        color: white;
    }

    @media (max-width: 1000px) {
        .work,
        .row {
            gap: 2rem;
        }

        .row {
            flex-direction: column;
        }
    }
</style>